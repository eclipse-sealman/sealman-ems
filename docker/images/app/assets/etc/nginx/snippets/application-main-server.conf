# Copyright (c) 2025 Contributors to the Eclipse Foundation.
#
# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License, Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0
#
# SPDX-License-Identifier: Apache-2.0

# nginx configuration of application to include in a valid server block
    set  $docroot	/var/www/application;
    root $docroot/public;

    access_log /var/www/application/filestorage/logs/nginx/access.log accessFormat;
    error_log /var/www/application/filestorage/logs/nginx/error.log;
    error_log stderr;

    charset utf-8;


    location / {
        include /etc/nginx/snippets/application-cors-response.conf;
        try_files $uri /index.php$is_args$args;
    }
    
    location ~* ^/df/[^/]+/[^/]+/(.*)$ {


        # Tightly coupled with:
        # - ^/device/check/auth/firmware path in security.yml
        # - App\Controller\DownloadSecurityFirmwareController.php
        # - location = /device/auth/firmware definition in this file
        auth_request /device/auth/firmware;

        # set filepath as responded by DownloadSecurityFirmwareController in headers
        auth_request_set $filepath $upstream_http_firmware_filepath;

        # get last part of uri as filename
        if ($request_uri ~* "^.*?\/([^\/]*?)$") {
            set $filename $1;
        }

        add_header Content-Disposition "attachment; filename=\"$filename\"";
        # HSTS (ngx_http_headers_module is required) (63072000 seconds)
        add_header Strict-Transport-Security "max-age=63072000" always;

        # list of headers is only inherited from previous level if no add_header is used in this level - so we need to include custom headers here
        include /etc/nginx/snippets/application-cors-response.conf;

        alias $docroot/private/firmware/$filepath;
    }

    location ~* ^/web/api/download/firmware/(.*)$ {

        # Tightly coupled with:
        # - ^/web/api/check/auth/admin path in security.yml
        # - App\Controller\DownloadSecurityAdminController.php
        # - location = /web/api/auth/admin definition in this file
        auth_request /web/api/auth/firmware;

        # set filepath as responded by DownloadSecurityFirmwareController in headers
        auth_request_set $filepath $upstream_http_firmware_filepath;


        # get last part of uri as filename
        if ($request_uri ~* "^.*?\/([^\/]*?)$") {
            set $filename $1;
        }

        
        add_header Content-Disposition "attachment; filename=\"$filename\"";
        # HSTS (ngx_http_headers_module is required) (63072000 seconds)
        add_header Strict-Transport-Security "max-age=63072000" always;

        # list of headers is only inherited from previous level if no add_header is used in this level - so we need to include custom headers here
        include /etc/nginx/snippets/application-cors-response.conf;
       
        alias $docroot/private/firmware/$filepath;
    }

    location ^~ /web/api/download/maintenance/ {

        # Tightly coupled with:
        # - ^/web/api/check/auth/admin path in security.yml
        # - App\Controller\DownloadSecurityAdminController.php
        # - location = /web/api/auth/admin definition in this file
        auth_request /web/api/auth/admin;

        # get last part of uri as filename
        if ($request_uri ~* "^.*?\/([^\/]*?)$") {
            set $filename $1;
        }

        add_header Content-Disposition "attachment; filename=\"$filename\"";
        # HSTS (ngx_http_headers_module is required) (63072000 seconds)
        add_header Strict-Transport-Security "max-age=63072000" always;

        # list of headers is only inherited from previous level if no add_header is used in this level - so we need to include custom headers here
        include /etc/nginx/snippets/application-cors-response.conf;

        alias $docroot/archive/;
    }

    location = /web/api/auth/admin {
        proxy_pass https://localhost/web/api/check/auth/admin;
        proxy_pass_request_body off;
        proxy_pass_header authorization;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
    }

    location = /web/api/auth/firmware {
        proxy_pass https://localhost/web/api/check/auth/firmware;
        proxy_pass_request_body off;
        proxy_pass_header authorization;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
    }

    location = /device/auth/firmware {
        proxy_pass https://localhost/device/check/auth/firmware;
        proxy_pass_request_body off;
        proxy_pass_header authorization;
        proxy_set_header X-CLIENT-SSL-CERT $ssl_client_escaped_cert;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
    }

    location ^~ /uploads {
        
        include /etc/nginx/snippets/application-cors-response.conf;

        if ($request_filename ~* ^.*?/([^/]*?)$) {
            set $filename $1;
        }

        expires 90d;
        alias $docroot/filestorage/public/uploads/;
    }

    location ^~ /.well-known/ {
        root /var/www/application/public/;
    }

    location ~ ^/index\.php(/|$) {

        include /etc/nginx/snippets/application-cors-response.conf;


        fastcgi_pass localhost:9000;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;
        fastcgi_param CLIENT_SSL_CERT $http_x_client_ssl_cert if_not_empty;
        fastcgi_param CLIENT_SSL_CERT $ssl_client_escaped_cert if_not_empty;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        internal;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|avif|webp|svg|swf|xml|txt|woff|woff2|ttf|otf|ico|pdf|flv)$ {
        expires 90d; 
    }

    gzip on;
    # GZIP only CSS and JS to avoid any potential problems with devices using communication procedure.
    # We did not verify whether devices using communication procedure actually have an issue with uncompressing.
    gzip_types text/css text/javascript application/javascript;
    gzip_proxied no-cache no-store private expired auth;
    gzip_comp_level 4;
